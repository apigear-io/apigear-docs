"use strict";(self.webpackChunkapigear=self.webpackChunkapigear||[]).push([[3120],{8439:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>s,metadata:()=>d,toc:()=>h});var r=n(4848),o=n(8453),i=n(1432),a=n(8529);n(3577);const s={sidebar_position:3},l="MQTT",d={id:"features/mqtt",title:"MQTT",description:"This is an experimental feature. It contains smallest working set of functionalities to adapt the generated interface for using over the network with MQTT protocol.",source:"@site/template-docs/template-python/docs/docs/features/mqtt.md",sourceDirName:"features",slug:"/features/mqtt",permalink:"/template-python/docs/features/mqtt",draft:!1,unlisted:!1,editUrl:"https://github.com/apigear-io/template-python/edit/main/docs/docs/features/mqtt.md",tags:[],version:"current",lastUpdatedAt:1725280298e3,sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"defaultSidebar",previous:{title:"Features",permalink:"/template-python/docs/features/"}},c={},h=[{value:"Before Start",id:"before-start",level:3},{value:"File overview for module",id:"file-overview-for-module",level:2},{value:"Python apigear - The Network Layer",id:"python-apigear---the-network-layer",level:3},{value:"MQTT Client Adapter",id:"mqtt-client-adapter",level:3},{value:"Properties",id:"properties",level:4},{value:"Operations",id:"operations",level:4},{value:"Signals",id:"signals",level:4},{value:"Use <code>HelloClientAdapter</code>",id:"use-helloclientadapter",level:4},{value:"MQTT Server Adapter",id:"mqtt-server-adapter",level:3},{value:"Properties",id:"properties-1",level:4},{value:"Operations",id:"operations-1",level:4},{value:"Signals",id:"signals-1",level:4},{value:"Use <code>HelloServiceAdapter</code>",id:"use-helloserviceadapter",level:4},{value:"MQTT Messages",id:"mqtt-messages",level:3}];function p(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components},{Details:s}=t;return s||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"mqtt",children:"MQTT"})}),"\n",(0,r.jsx)(t.admonition,{type:"caution",children:(0,r.jsx)(t.p,{children:"This is an experimental feature. It contains smallest working set of functionalities to adapt the generated interface for using over the network with MQTT protocol.\nIt doesn't include the security. The error handling is minimal. It is not production ready.\nPlease also check issues on github for this template."})}),"\n",(0,r.jsxs)(t.p,{children:["This feature purpose is not only to help you introduce MQTT protocol into your project, but also show that an existing protocol can be adapted for sharing your data in your ecosystem. When going through this document you may notice this implementation contains general client/server adapters in \ud83d\udcc2hello-world/apigear/mqtt\nand an interface specific part generated from templates for each interface in  \ud83d\udcc2hello-world/py_hello_world/io_world/mqtt. ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"\nThis feature provides a ",(0,r.jsx)(t.em,{children:"client"})," and a ",(0,r.jsx)(t.em,{children:"server"})," adapter for your interfaces for the MQTT protocol. It allows you to connect different applications in the same or different technologies (check all of our ",(0,r.jsx)(t.a,{href:"/docs/sdk/intro",children:"templates"}),").",(0,r.jsx)("br",{}),"\nUse an ",(0,r.jsx)(t.em,{children:"Mqtt client"})," instead of your interface implementation to be able to receive data from remote service.",(0,r.jsx)("br",{}),"\nUse an ",(0,r.jsx)(t.em,{children:"Mqtt server adapter"})," to expose your interface implementation as a remote service.",(0,r.jsx)("br",{})]}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsx)(t.p,{children:"The MQTT broker is not provided with implementation. To be able to run client and service you need to run a broker of your choice."})}),"\n",(0,r.jsx)(t.h3,{id:"before-start",children:"Before Start"}),"\n",(0,r.jsx)(t.p,{children:"The mqtt library needs to be installed separately, make sure you have installed all the libraries listed in requirements"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"`pip install --upgrade -r requirements.txt`\n"})}),"\n",(0,r.jsx)(t.h2,{id:"file-overview-for-module",children:"File overview for module"}),"\n",(0,r.jsx)(t.p,{children:"With an example  API"}),"\n",(0,r.jsxs)(s,{children:[(0,r.jsx)("summary",{children:"Hello World API (click to expand)"}),(0,r.jsx)(i.A,{language:"yaml",showLineNumbers:!0,children:a.A})]}),"\n",(0,r.jsx)(t.p,{children:"the following file structure will be generated. The purpose and content of each file is explained below."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",metastring:"{4,19}",children:"\ud83d\udcc2hello-world\n \u2523 \ud83d\udcc2apigear\n \u2503 ...\n \u2523 \ud83d\udcc2py_hello_world\n \u2503 \u2523 \ud83d\udcc2apigear\n \u2503 \u2503 \u2523 \ud83d\udcc2mqtt\n \u2503 \u2503 \u2503 \u2523 \ud83d\udcdcbase.py\n \u2503 \u2503 \u2503 \u2523 \ud83d\udcdcclient.py\n \u2503 \u2503 \u2503 \u2523 \ud83d\udcdcservice.py\n \u2503 \u2503 \u2503 \u2517 \ud83d\udcdc__init__.py\n \u2503 \u2503 \u2503 \n \u2503 \u2523 \ud83d\udcc2examples\n \u2503 \u2523 \ud83d\udcc2io_world\n \u2503 \u2503 \u2523 \ud83d\udcc2api\n \u2503 \u2503 \u2523 \ud83d\udcc2impl\n \u2503 \u2503 \u2523 \ud83d\udcc2mqtt\n \u2503 \u2503 \u2503 \u2523 \ud83d\udcdcsinks.py\n \u2503 \u2503 \u2503 \u2523 \ud83d\udcdcsources.py\n \u2503 \u2503 \u2503 \u2517 \ud83d\udcdc__init__.py\n ...\n"})}),"\n",(0,r.jsx)(t.h3,{id:"python-apigear---the-network-layer",children:"Python apigear - The Network Layer"}),"\n",(0,r.jsxs)(t.p,{children:["When generating the mqtt feature (or any of those: olink monitor feature) you'll get an additional folder it the top most directory: the \ud83d\udcc2hello-world/\ud83d\udcc2apigear. The \ud83d\udcc2mqtt subfolder contains objects that implement a network layer (based on ",(0,r.jsx)(t.a,{href:"https://pypi.org/project/paho-mqtt/",children:"Paho Mqtt library"}),") for the MQTT protocol. Those are:"]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Client - Adapts the MQTT client, to serve as an network endpoint for ",(0,r.jsx)(t.a,{href:"mqtt#mqtt-client-adapter",children:"interface client adapters"}),".\nExposes:","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"methods that allow receiving data for remote service: subscribing for properties changes, signals emission and method response invocation;"}),"\n",(0,r.jsxs)(t.li,{children:["methods that allow remote using the service: requesting property change or invoking a method.  ",(0,r.jsx)("br",{}),"\nThe client may serve many client interface adapters, even for the same interfaces (allows subscribing for same topic).\nIn case many interface client adapters for same interface are connected: property changes and signals are provided to all interface client adapters, but the invoke method response will be delivered only for the one that requested it."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["Service - Adapts the MQTT client to serve as an network endpoint for ",(0,r.jsx)(t.a,{href:"mqtt#mqtt-server-adapter",children:"interface service adapters"}),".\nExposes:","\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"methods that allow receiving requests from remote clients: subscribing for properties change requests, send method invocation;"}),"\n",(0,r.jsxs)(t.li,{children:["methods that allow publishing property change, signal, functionality to handles sending a response for method invocation requests. ",(0,r.jsx)("br",{}),"\nThis Service may be used for many, interface service adapters, but it is not recommended to use more than one interface service adapter for the same interfaces."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(t.admonition,{type:"tip",children:(0,r.jsx)(t.p,{children:"Have in mind that MQTT might not be suitable for high-frequency messages especially with one mqtt client serving more than one object.\nAlso the brokers have limits for messages number/size queued from one client. In case you are not getting all the messages consider changing those or splitting traffic between more clients (maybe some handle the properties, some handle the methods)."})}),"\n",(0,r.jsx)(t.h3,{id:"mqtt-client-adapter",children:"MQTT Client Adapter"}),"\n",(0,r.jsxs)(t.p,{children:["File ",(0,r.jsx)(t.code,{children:"\ud83d\udcdcsinks.py"})," contains the remote client for the ",(0,r.jsx)(t.code,{children:"Hello"})," interface  - a ",(0,r.jsx)(t.code,{children:"HelloClientAdapter"})," class.",(0,r.jsx)("br",{}),"\nThe object is an ",(0,r.jsx)(t.code,{children:"IHello"})," implementation.",(0,r.jsx)("br",{}),"\nIt requires an instance of Apigear::Mqtt::Client to work. It uses the Client to subscribe (and unsubscribe) for topics that allow receiving properties, signals and invoke responses from service."]}),"\n",(0,r.jsx)(t.h4,{id:"properties",children:"Properties"}),"\n",(0,r.jsxs)(t.p,{children:["The property getters (here getter ",(0,r.jsx)(t.code,{children:"get_last"}),") return immediately the locally stored last received value from server. ",(0,r.jsx)("br",{}),"\nThe property setter (here setter ",(0,r.jsx)(t.code,{children:"set_last"})," ) requests setting a value on server side, local value is not changed. ",(0,r.jsx)("br",{}),"\nYou can add handler for a property changed event (here ",(0,r.jsx)(t.code,{children:"on_last_changed(Message)"})," )\nWhen the client receives information that server changed the property, a target property (here ",(0,r.jsx)(t.code,{children:"last"}),") is updated locally and all handlers added for the event are fired (in addition order) with the new value of property."]}),"\n",(0,r.jsx)(t.admonition,{type:"note",children:(0,r.jsx)(t.p,{children:"The connected interface client adapter has its local properties in sync with a service. The properties messages are retained in mqtt broker, so all already set properties are provided."})}),"\n",(0,r.jsx)(t.h4,{id:"operations",children:"Operations"}),"\n",(0,r.jsxs)(t.p,{children:["The operations are async, and they return a coroutine awaited with a timeout of 500 seconds.",(0,r.jsx)("br",{}),"\nThe async method sends an invoke operation request to a service and waits for the response.",(0,r.jsx)("br",{}),"\nHave in mind that this is a blocking operation."]}),"\n",(0,r.jsx)(t.h4,{id:"signals",children:"Signals"}),"\n",(0,r.jsxs)(t.p,{children:["You should not emit any signals from a client.\nYou can add a handler to any signals offered by your interface (here ",(0,r.jsx)(t.code,{children:"void just_said(Message)"})," )\nWhen a HelloClientAdapter client receives the message from server that indicates the signal was emitted it executes all added handlers to a ",(0,r.jsx)(t.code,{children:"on_just_said"})," event hook."]}),"\n",(0,r.jsxs)(t.h4,{id:"use-helloclientadapter",children:["Use ",(0,r.jsx)(t.code,{children:"HelloClientAdapter"})]}),"\n",(0,r.jsxs)(t.p,{children:["HelloClientAdapter is an adapter of you interface to the Mqtt Client (with protocol and network layer implementation), here provided by a ",(0,r.jsx)(t.code,{children:"apigear.mqtt.Client"}),".\nAll you need to do is to pass the ",(0,r.jsx)(t.code,{children:"apigear.mqtt.Client"})," to your Interface Client Adapter, and request connecting to host when it is convenient for you.\nYou can find the example code for the your ",(0,r.jsx)(t.code,{children:"Hello"})," MQTT client below. Remember to run a MQTT broker of your choice."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'import os\nimport sys\n# add context - your relative path from this example to py_hello_world dir e.g. like this\nsys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), \'../\')))\n\nimport apigear.mqtt\nimport logging\nimport io_world.mqtt\nimport io_world.api\n\nasync def main():\n    # create a mqtt adapter for client side\n    client = apigear.mqtt.Client("UniqueClientNameForMqttHelloExample")\n\n    # create mqtt interface adapters for client side\n    mqtt_hello = io_world.mqtt.HelloClientAdapter(client)\n    await client.connect("localhost", 1883)\n\n    # Subscribe for property changes\n    def handleProperty(value):\n        print("received property change");\n        print(value);\n    mqtt_hello.on_last_changed += handleProperty\n    # or ask for change.\n    local_last = io_world.api.Message();\n    local_last.content = "New message"\n    mqtt_hello.set_last(local_last);\n    \n    # Check the signals with subscribing for its change\n    def handleSignal(value):\n        print("received signal");\n        print(value);\n    mqtt_hello.on_just_said += handleSignal\n    \n    # Play around executing your operations\n    message_to_say = io_world.api.Message()\n    message_to_say.content = "Message to say"\n    result = mqtt_hello.say(message_to_say, io_world.api.When.NOW)\n    await result\n    print("method result")\n    print(result)    \n    \n    input("Press Enter to close")\n\n    client.disconnect()\n\nif __name__ == \'__main__\':\n    loop = asyncio.new_event_loop()\n    asyncio.set_event_loop(loop)\n    loop.run_until_complete(main())\n'})}),"\n",(0,r.jsx)(t.h3,{id:"mqtt-server-adapter",children:"MQTT Server Adapter"}),"\n",(0,r.jsxs)(t.p,{children:["File ",(0,r.jsx)(t.code,{children:"\ud83d\udcdcsources.py"})," contains the mqtt server side adapter for the ",(0,r.jsx)(t.code,{children:"Hello"})," interface - the ",(0,r.jsx)(t.code,{children:"HelloServiceAdapter"})," object.",(0,r.jsx)("br",{}),"\nWhen creating the ",(0,r.jsx)(t.code,{children:"HelloServiceAdapter"})," you need to provide the ",(0,r.jsx)(t.code,{children:"apigear.mqtt.Service"})," and the local implementation of ",(0,r.jsx)(t.code,{children:"IHello"}),", local service.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(t.code,{children:"HelloServiceAdapter"})," object exposes the local object for remote usage with the MQTT protocol. It handles all the network requests, and calls your local object.\nThe mqtt client connection and communication is handled transparently, no additional actions are needed."]}),"\n",(0,r.jsx)(t.h4,{id:"properties-1",children:"Properties"}),"\n",(0,r.jsxs)(t.p,{children:["The MQTT service adapters add handlers for all the properties changes to the local implementation. On property change the generated implementation executes all added handlers.\nIn this example on each ",(0,r.jsx)(t.code,{children:"last"})," property change the handler for ",(0,r.jsx)(t.code,{children:"on_last_changed(Message)"}),", sends a message with a topic specific for this property in this interface and with value in the payload.\nThis happens either when you change a property directly on your local ",(0,r.jsx)(t.code,{children:"Hello"})," object, or when a change property request message is received by the ",(0,r.jsx)(t.code,{children:"HelloServiceAdapter"}),", which applies the property on your local ",(0,r.jsx)(t.code,{children:"Hello"})," object."]}),"\n",(0,r.jsx)(t.h4,{id:"operations-1",children:"Operations"}),"\n",(0,r.jsxs)(t.p,{children:["The operations invocation which came from the clients through the network will be performed on your local ",(0,r.jsx)(t.code,{children:"Hello"})," object. The result of the operation (if any) will be returned only to a client, from which the message was send, not all clients."]}),"\n",(0,r.jsx)(t.h4,{id:"signals-1",children:"Signals"}),"\n",(0,r.jsxs)(t.p,{children:["The MQTT service adapters add handlers for all the signals to the local implementation which send MQTT messages with information about signal emission with their arguments. On signal emission the generated implementation executes all handlers added for this signal.\nAll the signals emitted by your local ",(0,r.jsx)(t.code,{children:"Hello"})," objects are forwarded to all connected clients."]}),"\n",(0,r.jsxs)(t.h4,{id:"use-helloserviceadapter",children:["Use ",(0,r.jsx)(t.code,{children:"HelloServiceAdapter"})]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"HelloServiceAdapter"})," an adapter of your interface to the specific, object server side, version of Mqtt Client (with protcol and network layer implementation), here provided by a ",(0,r.jsx)(t.code,{children:"ApiGear::Mqtt::ServiceAdapter"}),"\nAll you need to do is to pass this ServiceAdapter to your Interface Service Adapter, and request connecting to host when it is convenient for you.\nYou can find the example code for the your ",(0,r.jsx)(t.code,{children:"Hello"})," MQTT service below. Remember to run a MQTT broker of your choice."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'import os\nimport sys\n# add context - your relative path from this example to py_hello_world dir e.g. like this\nsys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), \'../\')))\n\nimport apigear.mqtt\nimport io_world.impl\nimport io_world.mqtt\nimport io_world.api\n\nasync def main():\n    service = apigear.mqtt.Service("uniqueServiceIdForHelloService")\n    source_io_world_hello = io_world.impl.Hello()\n    serviceAdapter_io_world_hello = io_world.mqtt.HelloServiceAdapter(source_io_world_hello, service)\n\n    await service.connect("localhost", 1883)\n    \n    # Set property, the change will be sent to all clients, and local handlers if any.\n    local_last = io_world.api.Message();\n    local_last = "New message from server"\n    source_io_world_hello.set_last(local_last);\n\n    # Emit the signal, it will be sent to all clients\n    signal_message = io_world.api.Message()\n    signal_message = "New message from server"\n    source_io_world_hello._just_said(signal_message)\n    \n    input("Press Enter to close")\n    service.disconnect()\n\nif __name__ == \'__main__\':\n    loop = asyncio.new_event_loop()\n    asyncio.set_event_loop(loop)\n    loop.run_until_complete(main())\n\n'})}),"\n",(0,r.jsx)(t.admonition,{type:"note",children:(0,r.jsxs)(t.p,{children:["The implemented Mqtt Client (used both in apigear.mqtt.Client and apigear.mqtt.Service ) uses a thread to process network traffic. This mean, if you're having an asynchronous application, that reacting on the events inside you handlers (for all: properties, signals, operation results) may require using\n",(0,r.jsx)(t.code,{children:"loop.call_soon_threadsafe(callback, *args)"})," to handle the output in your main event loop."]})}),"\n",(0,r.jsx)(t.h3,{id:"mqtt-messages",children:"MQTT Messages"}),"\n",(0,r.jsxs)(t.p,{children:["In case you want construct messages for client or server side on your own, please check how topics are created and how does the payload look like, check this documentS ",(0,r.jsx)(t.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:n(3553).A+"",children:"messages format"}),"."]})]})}function m(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},3577:(e,t,n)=>{n.p},3553:(e,t,n)=>{n.d(t,{A:()=>r});const r=n.p+"assets/files/ApiGearMQTTv0.1-b44583aa1c3fc1e5416afe55dd6470db.pdf"},8529:(e,t,n)=>{n.d(t,{A:()=>r});const r='schema: apigear.module/1.0\nname: io.world\nversion: "1.0.0"\n\ninterfaces:\n  - name: Hello\n    properties:\n      - { name: last, type: Message }\n    operations:\n      - name: say\n        params:\n          - { name: msg, type: Message }\n          - { name: when, type: When }\n        return:\n          type: int\n    signals:\n      - name: justSaid\n        params:\n          - { name: msg, type: Message }\nenums:\n  - name: When\n    members:\n      - { name: Now, value: 0 }\n      - { name: Soon, value: 1 }\n      - { name: Never, value: 2 }\nstructs:\n  - name: Message\n    fields:\n      - { name: content, type: string }\n'}}]);